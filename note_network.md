# 理解网络模型和协议

ISO提出了OSI（开放系统互联）协议，但未能广泛应用。
TCP/IP模型：从上至下 应用层、传输层、网络层、网络接口层

了解：

网络分层模型（ISO与 TCP/IP对比）

TCP/IP模型每层什么职责？
网络接口层，将上面的网络层数据分成帧，交由物理链路传输，或者从网络上（数据链路）获取物理帧，抽取并转发至网络层。（两个方向的处理）

网络层，发送端和接收端建立一条虚拟路径，即路由。不保证数据完整和正确，这将由传输层完成。
该层的ARP协议（地址解析协议）和RARP（反向xxxx协议）用于IP地址和物理地址（通常是网卡地址）的转换
传输出错的话，ICMP协议产生错误报文。

传输层，TCP/UDP
应用层，FTP/Telnet/SMTP/HTTP

## 在TCP/IP通信中，`accept()`函数创建新的套接字（socket）是为了实现**并发服务**和**连接隔离**，这是TCP服务器设计的核心机制。具体原因如下：

---

### 1. **监听套接字 vs 连接套接字**
   - **监听套接字（Listening Socket）**  
     由`socket()`创建并通过`bind()`和`listen()`初始化的套接字，**仅用于接收连接请求**（三次握手）。它不直接参与数据传输。
   - **连接套接字（Connected Socket）**  
     由`accept()`返回的新套接字，**专属于某个客户端**，用于与该客户端的数据传输。每个新连接都会生成一个独立的连接套接字。

   **类比**：  
   监听套接字像公司的总机电话（只接听来电），连接套接字像分机（专门处理某个客户的通话）。

---

### 2. **为什么需要独立的连接套接字？**
   - **并发处理**  
     服务器需要同时处理多个客户端连接。监听套接字持续接收新连接，而每个连接套接字独立处理一个客户端的数据传输（通过多线程/多进程或I/O多路复用）。
   - **隔离连接状态**  
     每个TCP连接有独立的序列号、窗口大小、缓冲区等状态信息。连接套接字隔离这些状态，避免互相干扰。
   - **资源管理**  
     当某个连接关闭时，只需销毁对应的连接套接字，不影响其他活跃连接或监听套接字。

---

### 3. **底层原理**
   - 当客户端发起连接时，内核完成三次握手后，将连接放入服务器的**已完成连接队列**。
   - `accept()`从队列中取出一个连接，**克隆一个新的套接字描述符**，指向该连接的控制块（包含IP、端口、状态等）。
   - 原始监听套接字继续监听其他连接请求。

---

### 4. **如果不这样做会怎样？**
   - 若直接用监听套接字传输数据，服务器将无法接收新连接。
   - 所有客户端共享同一个套接字，导致数据混乱（无法区分不同客户端的数据流）。

---

### 示例代码片段
```c
int listen_sock = socket(AF_INET, SOCK_STREAM, 0); // 监听套接字
bind(listen_sock, ...);
listen(listen_sock, 5);

while (1) {
    int conn_sock = accept(listen_sock, ...);  // 为每个连接创建新套接字
    fork(); // 或多线程/IO多路复用处理conn_sock
}
```

---

### 总结
`accept()`创建新套接字是TCP服务器实现**一对多并发服务**的关键设计，确保了连接之间的独立性和系统的可扩展性。